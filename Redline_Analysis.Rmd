---
title: "Redlining in Current Environmental Injustices"
author: "Kate Becker"
date: "2023-12-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, eval = FALSE)
```


# Overview 
The term "environmental injustice" leads people to believe this is a 


Redlining was the practice of categorically denying access to mortagages not jsut to individuals but to whole neighborhoods 

For more information regarding the workflow, data, and reproducibility of this repository please see the Github link below
Github: https://github.com/kateebeckerr/Redlining_Injustices


# Data Descriptors

1. EJ Screen: Data from the United States Environmental Protection Agency's Environmental Justice Screening and Mapping Tool. This data is publicly accessible in order to be more transparent about how they consider environmental justice(EJ) in their work, to assist stakeholders in making informed decisions about pursuing EJ, and to create a common starting point between the agency and the public when looking at issues in EJ. This data provides environmental and demographic information for the US and census tract and block groups but in this particular analysis, only the block group data will be explored. 

2. Mapping Inequality: This data comes from the Mapping Inequality: Redlining in New Deal America project. This is an online mapping tool that enables you to explore pre-existing redlining maps for almost every major American City as well as is history of raical and ethnic discrimination in housing policy. As we will see in this analysis,  neighborhoods were given HOLC grades. Those that they deemed "best" and safe investments were given a grade of A and colored green. Those that were deemed "hazardous" were given a grade of "D" and colored red. The map of Los Angeles was selected for this analysis. 

3. Biodiversity: The Global Biodiversity Information Facility is a international network and data infrastructure funded by the worlds government that aims to provides free and open access to biodiversity data. The data used in this analysis is bird observations from 2021 and onward. 


## Relevant Libraries and Setting Path
```{r}
library(tidyverse)
library(sf)
library(tmap)
library(spData)
library(spDataLarge)
library(terra)
library(dplyr)
library(ggplot2)
library(raster)
library(maps)
library(spData)
library(grid)
library(viridis)
library(tmap)
library(tmaptools)

rm(list = ls())
```

## Data Read In

### LA EJ Screen 
```{r}
ejscreen <- st_read("./data/EJSCREEN_2023_BG_StatePct_with_AS_CNMI_GU_VI.gdb/") 
#filter for LA county
LA <- ejscreen %>%
  filter(CNTY_NAME %in% c("Los Angeles County")) #filter for Los Angeles County
```
### Biodiversity Data
```{r}
biodiversity <- st_read("/Users/katebecker/Documents/Bren/Fall_Q/EDS_223/final/Redlining/Redlining_Injustices/data/gbif-birds-LA") 
```
### LA Redlining
```{r}
LA_redlining <- st_read("https://dsl.richmond.edu/panorama/redlining/static/citiesData/CALosAngeles1939/geojson.json") %>%
  st_make_valid() #makes a geometry valid by fixing any topological errors or inconsistencies in the geometry 
```

## Data Exploration 

Visualizing Variables of Interest 
```{r}
plot(LA["ID"])
plot(LA_redlining["grade"])

plot(biodiversity)
plot(LA_redlining)
```

## Analysis 

### Make a map of wastewater discharge by census block groups. Indicate which census block groups are above the 95th percentile of wastewater discharge (P_PWDIS) by adding a centroid 

#### Data Cleaning

```{r}
LA_ejscreen_centroids <- st_centroid(LA) %>% #computes the centroid of each geometryin LA spatial object
  filter(P_PWDIS > 95) #filters the centroids for census block groups above 95th percentile 

census_95 <- LA %>% 
  filter(P_PWDIS >= 95) #filters LA spatial object to include only geometries where P_PWDIS is greater than or equal to 95

census_95 <- st_centroid(census_95) #calculates the centroids of the geometries in census_95

coordLA <- st_bbox(LA) #extracted the coordinates of LA to use them in the following map 

print(coordLA) 
```

#### Map

```{r}
LA_waste_1 <- LA %>%
  ggplot() +
  geom_sf(data = LA, aes(fill = P_PWDIS))+ 
  geom_sf(data = census_95, color = "red", shape = 5, size = 0.5) +
  scale_fill_gradient(low = "lightyellow", high = "darkorange", name = "Percentile for Wastewater discharge") +
  coord_sf(
    ylim = c(3980000, 4139895)
  ) +
  ggtitle("Wastewater in Los Angeles County") 

LA_waste_1
```



Find the percent of census block groups that have:  
- less than 5% of the population is considered low income
(5 points)


```{r}
low_income_5 <- LA %>%
  filter(LOWINCPCT < 0.05) 
  
percent_low <- (nrow(low_income_5) / nrow(LA)) * 100

print(percent_low)
```


Find the percent of census block groups that are:    
- above the 80th percentile for Particulate Matter 2.5 AND  
- above the 80th percentile for Superfund proximity
(10 points)

```{r}
has_data <- LA %>%
  filter(!is.na(P_PM25)) %>%
  filter(!is.na(P_PNPL))

LA %>% 
  filter(P_PM25 > 80) %>%
  filter(P_PNPL > 80) %>%
  nrow()/nrow(has_data)*100
```

Make a map of historical redlining boundaries, colored by HOLC grade.
(5 points)

```{r}
coordLA_red <- st_bbox(LA_redlining)
print(coordLA_red)

crs1 <- st_crs(LA)
crs2 <- st_crs(LA_redlining)

LAred_transformed <- st_transform(LA_redlining, crs1)

LA_LAredline <- st_intersects(LAred_transformed, LA)

```

```{r}
LA_LAred <- LA %>%
  ggplot() +
  geom_sf(data = LA) +
  geom_sf(data = LA_redlining, aes(fill = grade)) +
  ggtitle("Redlining in Los Angeles by HOLC Grade") +
  coord_sf(
    ylim = c(3980000, 4139895)
  )

print(LA_LAred)

```
Find the number of census block groups that fall within areas with HOLC grades
hint: make sure the CRS match

```{r}
LA <- st_transform(LA, crs= st_crs(LA_redlining))


binary_list <- st_intersects(x = LA, y = LA_redlining) # returns binary predicate list
logical_intersect = lengths(binary_list) > 0 # create logical of which items do intersect
redlining_cbg <- LA[logical_intersect, ] # filter census block groups based on logicals

# the number of census block groups
print(paste("There are", nrow(redlining_cbg), "census block groups falling within areas with HOLC grades"))
```

Summarize current conditions based on EJScreen data within historical redlining categories using the mean of the following variables:  
-% low income.  
- percentile for particulate Matter 2.5.  
- percentile for low life expectancy.  
- percentile for air toxics cancer risk
(20 points)
```{r}
LA_Grade <- st_transform(LA, crs = st_crs(LA_redlining))

LA_red <- st_intersection(LA_redlining, LA_Grade)

LA_red %>%
  group_by(grade) %>%
  summarise(lowincpct = mean(LOWINCPCT, na.rm = TRUE),
            pm25 = mean(P_PM25, na.rm = TRUE),
            lifeexppct = mean(P_LIFEEXPPCT, na.rm = TRUE),
            cancer = mean(P_CANCER, na.rm = TRUE))
```

## Investigating the Legacy 
Investigate the legacy of redlining in biodiversity observations
For bird observations from 2022 that fall within neighborhoods with HOLC grads, find the percent of observations within each redlining categories and plot results. hint: make sure that the bird observations have the same CRS as redlining data. (20 points)

```{r}
bio_22 <- biodiversity  %>%
  filter(year == 2022) # filter to 2022

# transform data to match CRS
biodiversity_transform <- st_transform(bio_22, crs = st_crs(LA_redlining))
```


```{r}
biodiv_data <- st_join(x = biodiversity_transform, y = LA_redlining, join = st_within, left = FALSE)

biodiv_summary <- biodiv_data %>% 
  st_set_geometry(NULL) %>%
  group_by(grade) %>%                  
  summarise(count = n()) %>%      
  mutate(percentage = (count / sum(count))*100 )

ggplot(data = biodiv_summary) +
  geom_bar(aes(x = grade, y = percentage, fill = grade), stat = "identity") +
  labs(x = "HOLC grade", y = "Percentage of observations") +
  scale_fill_discrete() +
  ggtitle("Redlining in Biodiversity Observations")
```

## Findings 





